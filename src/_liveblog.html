<%
var { typogrify } = require("typogr");
var moment = require("moment-timezone");
var timezone = "America/New_York";

// clean up and index posts
var lookup = {};
var posts = doc.posts.filter(function(post, index) {
  lookup[post.slug] = post;
  post.index = index;
  // only do this one time through the template
  if (typeof post.published == "string") {
    post.published = post.published.trim() == "false" ? false : moment(post.published).tz(timezone);
    if (post.published) {
      post.timeString = post.published.format("h:mm a z");
      post.dateString = post.published.format("MMM. D, YYYY");
    }
  }
  return flags.unpublished || post.published;
});
posts.sort(function(a, b) {
  if (!a.published && !b.published) {
    // put unpublished at the top in order
    return a.index - b.index;
  }
  return (b.published || Infinity) - (a.published || Infinity);
});

%>

<main class="liveblog">
  <h1><%= config.headline %></h1>
<%
var featured = lookup[config.featured];
posts = posts.filter(p => p != featured);
if (featured) {
%>

<article class="featured post" id="featured">
  <h2><%= typogrify(featured.headline) %></h2>
  <div class="contents">
    <%= t.renderMarkdown(featured.text) %>
  </div>
</article>

<%
}
%>

<button class="show-new hidden">Show <span class="count">0</span> new posts</button>

<%
posts.forEach(function(post) {
%>

<article class="post <%= post.published ? "published" : "draft" %>" id="<%= post.slug %>">
  <div class="metadata">
    <div class="datetime">
      <div class="time">
        <%= post.timeString || "unpublished" %>
      </div>
      <div class="date">
        <%= post.dateString || "" %>
      </div>
    </div>
    <a
      href="#<%= post.slug %>"
      class="permalink"
      data-copy="<%= grunt.data.json.project.url + "#" + post.slug %>">
        Copy link
        <div class="copy-message" aria-hidden>Copied!</div>
    </a>
  </div>
  <div class="contents">
    <h2><%= typogrify(post.headline) %></h2>
    
    <%= t.renderMarkdown(post.text) %>

    <% if (post.page) { %>
    <div class="author">
      &mdash; <a href="<%= post.page %>"><%= post.author %></a>
    </div>
    <% } else { %>
    <div class="author">&mdash; <%= post.author %></div>
    <% } %>

  <a class="back-to-top" href="#featured">&uarr; Back to top</a>
  </div>
</article>
<%
});
%>
</main>